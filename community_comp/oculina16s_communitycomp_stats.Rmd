---
title: "oculina16s_communitycomp"
output: html_document
date: '2022-06-08'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup

```{r packages composition}
library(rlang)
library(stringr)
library(dplyr)
library(stats)
library(ggpubr)
library(vegan)
library(cowplot)
library(tidyverse)
#library(MCMC.OTU)
#install.packages("remotes")
#remotes::install_github("Jtrachsel/funfuns")
library("funfuns")
#BiocManager::install("microbiome")
#remotes::install_github("r-lib/rlang")
library(microbiome)
```


Read in data

```{r read in data}
setwd("~/oculina/data")
samdf <- read.csv("oculina16s_sampledata_symdens.csv",header=TRUE)
load("taxa2.Rdata")
#load("ps.clean.Rdata")
load("ps.rare.Rdata")
#load("ps.rare.trim.Rdata")
#load("ps.trim.Rdata")
#ps.cleanest <- readRDS("phyloseq.cleanest.RDS")

```


Rename ASVs to be more informative

```{r rename ASVs}
tax <- as.data.frame(ps.rare@tax_table@.Data)
tax.clean <- data.frame(row.names = row.names(tax),
                        Kingdom = str_replace(tax[,1], "D_0__",""),
                        Phylum = str_replace(tax[,2], "D_1__",""),
                        Class = str_replace(tax[,3], "D_2__",""),
                        Order = str_replace(tax[,4], "D_3__",""),
                        Family = str_replace(tax[,5], "D_4__",""),
                        Genus = str_replace(tax[,6], "D_5__",""),
                        Species = str_replace(tax[,7], "D_6__",""),
                        stringsAsFactors = FALSE)
tax.clean[is.na(tax.clean)] <- ""


for (i in 1:7){ tax.clean[,i] <- as.character(tax.clean[,i])}
####### Fill holes in the tax table
tax.clean[is.na(tax.clean)] <- ""
for (i in 1:nrow(tax.clean)){
  if (tax.clean[i,2] == ""){
    kingdom <- paste("Kingdom_", tax.clean[i,1], sep = "")
    tax.clean[i, 2:7] <- kingdom
  } else if (tax.clean[i,3] == ""){
    phylum <- paste("Phylum_", tax.clean[i,2], sep = "")
    tax.clean[i, 3:7] <- phylum
  } else if (tax.clean[i,4] == ""){
    class <- paste("Class_", tax.clean[i,3], sep = "")
    tax.clean[i, 4:7] <- class
  } else if (tax.clean[i,5] == ""){
    order <- paste("Order_", tax.clean[i,4], sep = "")
    tax.clean[i, 5:7] <- order
  } else if (tax.clean[i,6] == ""){
    family <- paste("Family_", tax.clean[i,5], sep = "")
    tax.clean[i, 6:7] <- family
  } else if (tax.clean[i,7] == ""){
    tax.clean$Species[i] <- paste("Genus",tax.clean$Genus[i], sep = "_")
  }
}

tax_table(ps.rare) <- as.matrix(tax.clean)


```



### Stats

# Transform data using centered log ratio (makes data symmetric and linearly related)
```{r transform data using CLR}
#library(microbiome)
ps.rare.clr <- transform(ps.rare, 'clr') #otu table: no longer counts, but rather the dominance (or lack thereof) for each taxa relative to the geometric mean of all taxa on the logarithmic scale
# read more here: https://www.nicholas-ollberding.com/post/introduction-to-the-statistical-analysis-of-microbiome-data-in-r/


#load("~/oculina/data/ps.rare.rev.clr.Rdata")
#subset coral
ps.coral <- subset_samples(ps.rare.clr,type=="coral")
ps.coral <- subset_samples(ps.rare,type=="coral")


ord.coral.clr <- ordinate(ps.coral, "RDA")
plot_scree(ord.coral.clr)+
  geom_bar(stat="identity",fill="blue")+
  labs(x = "\nAxis", y = "Proportion of Variance\n")

```

```{r new phyloseq with revised symbstate classifications}
seqtab.rare <- read.csv(file="~/oculina/data/oculina16s_rev_seqtab.rare.2k",row.names=1)
load("~/oculina/data/taxa2.rev.Rdata")
samdf <- read.csv(file="~/oculina/data/oculina16s_sampledata_symdens_new.csv")
row.names(samdf) <- samdf$id
ps.rare.new <- phyloseq(otu_table(seqtab.rare, taxa_are_rows=FALSE), 
                    sample_data(samdf), 
                    tax_table(taxa2))
#save(ps.rare.new,file="ps.rare.new.Rdata")

#need to also make new phyloseq for ancom analysis (non-rarefied)
seqtab.cleanest <- read.csv(file="~/oculina/data/oculina16s_rev_seqtab.cleanest.csv",row.names=1)
ps.cleanest.new <- phyloseq(otu_table(seqtab.cleanest, taxa_are_rows=FALSE), 
                    sample_data(samdf), 
                    tax_table(taxa2))
#save(ps.cleanest.new,file="ps.cleanest.new.Rdata")
```

```{r stats for coral (clr-transformed)}
seq.coral <- data.frame(otu_table(ps.coral))
dist.coral <- vegdist(seq.coral)
samdf.coral <- data.frame(sample_data(ps.coral))
row.names(samdf.coral)==row.names(seq.coral)


### ADONIS ###
# Question: Are centroids significantly different from one another?
# adonis needs to be done on distance matrix

adonis2(dist.coral ~ site, data=samdf.coral, permutations=999)
#         Df SumOfSqs      R2      F Pr(>F)    
#site      2   1.5246 0.09979 2.1617  0.001 ***
#Residual 39  13.7534 0.90021                  
#Total    41  15.2780 1.00000    

adonis2(dist.coral ~ season, data=samdf.coral, permutations=999) #*** ??
#         Df SumOfSqs      R2      F Pr(>F)    
#season    1   1.0044 0.06574 2.8147  0.001 ***
#Residual 40  14.2736 0.93426                  
#Total    41  15.2780 1.00000      

adonis2(dist.coral ~ symbstate, data=samdf.coral, permutations=999) #not sig


# will look at site and season as main effects as well as their interaction term
adonis2(dist.coral ~ site*season, data=samdf.coral, permutations=999) #not sig
#            Df SumOfSqs      R2      F Pr(>F)    
#site         2   1.5246 0.09979 2.2915  0.001 ***
#season       1   0.7769 0.05085 2.3353  0.001 ***
#site:season  1   0.6676 0.04369 2.0067  0.009 ** 
#Residual    37  12.3089 0.80566                  
#Total       41  15.2780 1.00000     

# site * symbstate
adonis2(dist.coral ~ site*symbstate, data=samdf.coral, permutations=999) #only site sig (***)

# season * symbstate
adonis2(dist.coral ~ season*symbstate, data=samdf.coral, permutations=999) #only season sig (***)

# try with just NR and CL, as it turns out w/ density data that CL aposymbiotic corals are not so apo after all
ps.coral.noCL <- subset_samples(ps.coral,site %in% c("NR","RI"))
seq.coral.noCL <- data.frame(otu_table(ps.coral.noCL))
dist.coral.noCL <- vegdist(seq.coral.noCL)
samdf.coral.noCL <- data.frame(sample_data(ps.coral.noCL))
row.names(samdf.coral.noCL)==row.names(seq.coral.noCL)
adonis2(dist.coral.noCL ~ symbstate, data=samdf.coral.noCL, permutations=999) #not sig



### BETADISPER ###
# If you have uneven variation in your data, adonis might not be effective -- should check for variation in dispersion using betadisper
# CORAL - SITE
bet.all <- betadisper(dist.coral,samdf.coral$site) #Betadisper calculates the average distance of group members to the group centroid in multivariate space (generated by a distance matrix). ANOVA/Permutest then tests whether distances are significantly different between groups.
    
    #Average distance to median:
    #    CL     NR     RI 
    #0.5076 0.5630 0.5972 

#anova(bet.all)
plot(bet.all) 
permutest(bet.all, pairwise = TRUE, permutations = 999) 
    #Response: distances
      #          Df   Sum Sq   Mean Sq      F N.Perm Pr(>F)  
      #Groups     2 0.049253 0.0246264 3.3667    999  0.046 *

# CORAL - SEASON
bet.all <- betadisper(dist.coral,samdf.coral$season)
plot(bet.all)
permutest(bet.all, pairwise = TRUE, permutations = 999) #not sig (p = 0.757)

# CORAL - SYMB STATE
bet.all <- betadisper(dist.coral,samdf.coral$symbstate)
plot(bet.all)
permutest(bet.all, pairwise = TRUE, permutations = 999) #not sig (p = 0.197)

# Excluding CL
bet.all <- betadisper(dist.coral.noCL,samdf.coral.noCL$symbstate)
plot(bet.all)
permutest(bet.all, pairwise = TRUE, permutations = 999) #not sig

```


```{r adonis and betadisper with ps.rare.new (includes some new symb state categorizations)}
ps.rare.new.clr <- transform(ps.rare.new, 'clr')
ps.rn.coral <- subset_samples(ps.rare.new, type=="coral")

seq.coral.rn <- data.frame(otu_table(ps.rn.coral))
dist.coral.rn <- vegdist(seq.coral.rn)
samdf.coral.rn <- data.frame(sample_data(ps.rn.coral))
row.names(samdf.coral.rn)==row.names(seq.coral.rn)


### ADONIS ###
# Question: Are centroids significantly different from one another?
# adonis needs to be done on distance matrix

adonis2(dist.coral.rn ~ symbstate, data=samdf.coral.rn, permutations=999) #not sig

# site * symbstate
adonis2(dist.coral.rn ~ site*symbstate, data=samdf.coral.rn, permutations=999) #only site sig (***)

# season * symbstate
adonis2(dist.coral.rn ~ season*symbstate, data=samdf.coral.rn, permutations=999) #only season sig (***)

```



```{r bubble plot}
library("reshape2")
library("stringr")
library("ggplot2")
library("RColorBrewer")

#setwd("~/oculina_old/setup/tax")
OTU = read.table("ASVtable.txt", header=TRUE, sep="\t", row.names = 1)
RAtab <- sweep(OTU,1,rowSums(OTU),"/")
#write.csv(RAtab, "ASVtablePercent.csv") #uncomment this to write out your new ASV table
#row sums before
rowSums(OTU)
#check row sums after-- should be 1 for all samples
rowSums(RAtab)


```

